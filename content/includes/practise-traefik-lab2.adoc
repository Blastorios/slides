[{invert}]
= Agenda

* {agenda-acme}
* **{agenda-rp}**
* {agenda-web}
* {agenda-ci}
* {agenda-scm}
* {agenda-ws}

[{invert}]
== Remember the Diagram?

image::traefik-architecture.png["Traefik's Architecture",width=1000]

[{invert}]
== In Kubernetes

image::traefik-kubernetes-diagram.png["Traefik with Kubernetes Diagram",width=900]

[.small]
Diagram from link:https://medium.com/@geraldcroes[]

== Let's Go

== Initialize Helm

[source,bash,subs="attributes"]
----
curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get | bash
# add a service account within a namespace to segregate tiller
kubectl --namespace kube-system create sa tiller
# create a cluster role binding for tiller
kubectl create clusterrolebinding tiller \
    --clusterrole cluster-admin \
    --serviceaccount=kube-system:tiller
# initialized helm within the tiller service account
helm init --service-account tiller
# updates the repos for Helm repo integration
helm repo update
----

== values.yaml file

* Step 1: Add rights on namespace
+
[source,yaml,subs="attributes"]
----
include::../../demo/lab-docker-k8s/02-k8s-traefik/traefik/values.yml[tag=rbac]
----

* Step 2: Set SSL EntryPoint with redirection
+
[source,yaml,subs="attributes"]
----
include::../../demo/lab-docker-k8s/02-k8s-traefik/traefik/values.yml[tag=ssl]
----

* Step 3: Add Let's Encrypt
+
[source,yaml,subs="attributes"]
----
include::../../demo/lab-docker-k8s/02-k8s-traefik/traefik/values.yml[tag=acme]
----

== Deploy Traefik

[source,bash,subs="attributes"]
----
helm install stable/traefik \
 --name traefik-devoxx \
 --namespace devoxx \
 --set imageTag=1.7.10 \
 --values values.yml
helm ls
----


== Access to Traefik

* Step 1: Run the command:
+
[source,bash,subs="attributes"]
----
kubectl --namespace=devoxx get services
----

* Step 2: Get the Load Balancer `EXTERNAL-IP`:
+
[source,bash,subs="attributes"]
----
NAME             TYPE           CLUSTER-IP       EXTERNAL-IP    PORT(S)                      AGE
traefik-devoxx   LoadBalancer   100.71.101.224   $EXTERNAL_IP   80:32256/TCP,443:31489/TCP   12s
----

* Step 3: Blue-Green on Traefik instances:

*TODO: dduportal*

[{invert}]
== Reality Check

link:http://{lab-domain}/[http://{lab-domain}/,window=_blank]

[.shadow]
image::after-traefik-up.png[]

It's good: we have an HTTP answer!
